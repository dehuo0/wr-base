dracut: fix files directory error

Issue: LIN6-10408

Signed-off-by: Li Wang <li.wang@windriver.com>
---
 dracut.sh                                         |    2 +-
 modules.d/10i18n/module-setup.sh                  |    4 ++++
 modules.d/90dm/59-persistent-storage-dm.rules     |    2 +-
 modules.d/90dmraid/61-dmraid-imsm.rules           |    2 +-
 modules.d/90dmraid/module-setup.sh                |    2 +-
 modules.d/90lvm/module-setup.sh                   |    2 ++
 modules.d/90mdraid/59-persistent-storage-md.rules |    2 +-
 modules.d/90mdraid/65-md-incremental-imsm.rules   |    2 +-
 modules.d/90mdraid/module-setup.sh                |    2 +-
 modules.d/90mdraid/parse-md.sh                    |    2 +-
 modules.d/90multipath/module-setup.sh             |    2 +-
 11 files changed, 15 insertions(+), 9 deletions(-)

diff --git a/dracut.sh b/dracut.sh
index 9b715ab..ce1649f 100755
--- a/dracut.sh
+++ b/dracut.sh
@@ -749,7 +749,7 @@ stdloglvl=$((stdloglvl + verbosity_mod_l))
 [[ $do_strip_l ]] && do_strip=$do_strip_l
 [[ $do_strip ]] || do_strip=yes
 [[ $do_prelink_l ]] && do_prelink=$do_prelink_l
-[[ $do_prelink ]] || do_prelink=yes
+[[ $do_prelink ]] || do_prelink=no
 [[ $do_hardlink_l ]] && do_hardlink=$do_hardlink_l
 [[ $do_hardlink ]] || do_hardlink=yes
 [[ $prefix_l ]] && prefix=$prefix_l
diff --git a/modules.d/10i18n/module-setup.sh b/modules.d/10i18n/module-setup.sh
index fcb18d1..1ccc1f4 100755
--- a/modules.d/10i18n/module-setup.sh
+++ b/modules.d/10i18n/module-setup.sh
@@ -109,6 +109,10 @@ install() {
     install_all_kbd() {
         local rel f
 
+        if ! [ -d "${kbddir}/{${KBDSUBDIRS}" ]; then
+            return
+        fi
+
         for _src in $(eval echo ${kbddir}/{${KBDSUBDIRS}}); do
             inst_dir "$_src"
             cp --reflink=auto --sparse=auto -prfL -t "${initdir}/${_src}" "$_src"/*
diff --git a/modules.d/90dm/59-persistent-storage-dm.rules b/modules.d/90dm/59-persistent-storage-dm.rules
index 73b0937..4fb1098 100644
--- a/modules.d/90dm/59-persistent-storage-dm.rules
+++ b/modules.d/90dm/59-persistent-storage-dm.rules
@@ -5,7 +5,7 @@ ENV{DM_MULTIPATH_DEVICE_PATH}=="?*", GOTO="dm_end"
 
 KERNEL!="dm-[0-9]*", GOTO="dm_end"
 ACTION=="add", GOTO="dm_end"
-IMPORT{program}="/sbin/dmsetup info -c --nameprefixes --unquoted --rows --noheadings -o name,uuid,suspended,readonly,major,minor,open,tables_loaded,names_using_dev -j%M -m%m"
+IMPORT{program}="dmsetup info -c --nameprefixes --unquoted --rows --noheadings -o name,uuid,suspended,readonly,major,minor,open,tables_loaded,names_using_dev -j%M -m%m"
 ENV{DM_NAME}!="?*", GOTO="dm_end"
 ENV{DM_UDEV_DISABLE_OTHER_RULES_FLAG}=="1", GOTO="dm_end"
 ENV{DM_UUID}=="CRYPT-TEMP-?*", GOTO="dm_end"
diff --git a/modules.d/90dmraid/61-dmraid-imsm.rules b/modules.d/90dmraid/61-dmraid-imsm.rules
index 33e060b..5fc4078 100644
--- a/modules.d/90dmraid/61-dmraid-imsm.rules
+++ b/modules.d/90dmraid/61-dmraid-imsm.rules
@@ -22,7 +22,7 @@ PROGRAM=="/bin/sh -c 'for i in $sys/$devpath/holders/dm-[0-9]*; do [ -e $$i ] &&
     GOTO="dm_end"
 
 ENV{DEVTYPE}!="partition", \
-    RUN+="/sbin/partx -d --nr 1-1024 $env{DEVNAME}"
+    RUN+="/usr/sbin/partx -d --nr 1-1024 $env{DEVNAME}"
 
 RUN+="/sbin/initqueue --onetime --unique --settled /sbin/dmraid_scan"
 
diff --git a/modules.d/90dmraid/module-setup.sh b/modules.d/90dmraid/module-setup.sh
index a9e27a6..061de0a 100755
--- a/modules.d/90dmraid/module-setup.sh
+++ b/modules.d/90dmraid/module-setup.sh
@@ -70,7 +70,7 @@ install() {
 
     inst_multiple dmraid
     inst_multiple -o kpartx
-    inst $(command -v partx) /sbin/partx
+    inst $(command -v partx) /usr/sbin/partx
 
     inst "$moddir/dmraid.sh" /sbin/dmraid_scan
 
diff --git a/modules.d/90lvm/module-setup.sh b/modules.d/90lvm/module-setup.sh
index a64e5d6..3a63fec 100755
--- a/modules.d/90lvm/module-setup.sh
+++ b/modules.d/90lvm/module-setup.sh
@@ -77,6 +77,7 @@ install() {
 
     inst_rules 11-dm-lvm.rules 69-dm-lvm-metad.rules
 
+if [ -f ${initdir}/lib/udev/rules.d/69-dm-lvm-metad.rules ]; then
     # Do not run lvmetad update via pvscan in udev rule  - lvmetad is not running yet in dracut!
     if grep -q SYSTEMD_WANTS ${initdir}/lib/udev/rules.d/69-dm-lvm-metad.rules; then
         sed -i -e 's/^ENV{SYSTEMD_ALIAS}=.*/# No LVM pvscan in dracut - lvmetad is not running yet/' ${initdir}/lib/udev/rules.d/69-dm-lvm-metad.rules
@@ -85,6 +86,7 @@ install() {
     else
         sed -i -e 's/.*lvm pvscan.*/# No LVM pvscan for in dracut - lvmetad is not running yet/' ${initdir}/lib/udev/rules.d/69-dm-lvm-metad.rules
     fi
+fi
 
     # Gentoo ebuild for LVM2 prior to 2.02.63-r1 doesn't install above rules
     # files, but provides the one below:
diff --git a/modules.d/90mdraid/59-persistent-storage-md.rules b/modules.d/90mdraid/59-persistent-storage-md.rules
index 6ef858a..16a197f 100644
--- a/modules.d/90mdraid/59-persistent-storage-md.rules
+++ b/modules.d/90mdraid/59-persistent-storage-md.rules
@@ -16,7 +16,7 @@ ATTR{md/array_state}=="|clear|inactive", GOTO="md_end"
 
 LABEL="md_ignore_state"
 
-IMPORT{program}="/sbin/mdadm --detail --export $tempnode"
+IMPORT{program}="mdadm --detail --export $tempnode"
 IMPORT BLKID
 OPTIONS+="link_priority=100"
 OPTIONS+="watch"
diff --git a/modules.d/90mdraid/65-md-incremental-imsm.rules b/modules.d/90mdraid/65-md-incremental-imsm.rules
index d66dd01..ec69edb 100644
--- a/modules.d/90mdraid/65-md-incremental-imsm.rules
+++ b/modules.d/90mdraid/65-md-incremental-imsm.rules
@@ -29,7 +29,7 @@ PROGRAM="/bin/sh -c 'for i in $sys/$devpath/holders/md[0-9_]*; do [ -e $$i ] &&
 # UUID CHECK
 
 ENV{DEVTYPE}!="partition", \
-    RUN+="/sbin/partx -d --nr 1-1024 $env{DEVNAME}"
+    RUN+="/usr/sbin/partx -d --nr 1-1024 $env{DEVNAME}"
 
 RUN+="/sbin/initqueue --timeout --name 50-mdraid_start --onetime --unique /sbin/mdraid_start"
 
diff --git a/modules.d/90mdraid/module-setup.sh b/modules.d/90mdraid/module-setup.sh
index 61483f2..8fb0bda 100755
--- a/modules.d/90mdraid/module-setup.sh
+++ b/modules.d/90mdraid/module-setup.sh
@@ -67,7 +67,7 @@ install() {
     local rule rule_path
     inst_multiple cat
     inst_multiple -o mdmon
-    inst $(command -v partx) /sbin/partx
+    inst $(command -v partx) /usr/sbin/partx
     inst $(command -v mdadm) /sbin/mdadm
 
     cmdline  >> "${initdir}/etc/cmdline.d/90mdraid.conf"
diff --git a/modules.d/90mdraid/parse-md.sh b/modules.d/90mdraid/parse-md.sh
index dd7bda2..ee4ebef 100755
--- a/modules.d/90mdraid/parse-md.sh
+++ b/modules.d/90mdraid/parse-md.sh
@@ -14,7 +14,7 @@ else
             [ -e "$f" ] || continue
             while read line; do
                 if [ "${line%%UUID CHECK}" != "$line" ]; then
-                    printf 'IMPORT{program}="/sbin/mdadm --examine --export $tempnode"\n'
+                    printf 'IMPORT{program}="mdadm --examine --export $tempnode"\n'
                     for uuid in $MD_UUID; do
                         printf 'ENV{MD_UUID}=="%s", GOTO="md_uuid_ok"\n' $uuid
                     done;
diff --git a/modules.d/90multipath/module-setup.sh b/modules.d/90multipath/module-setup.sh
index 261a957..bc84237 100755
--- a/modules.d/90multipath/module-setup.sh
+++ b/modules.d/90multipath/module-setup.sh
@@ -86,7 +86,7 @@ install() {
         /etc/multipath.conf \
         /etc/multipath/*
 
-    inst $(command -v partx) /sbin/partx
+    inst $(command -v partx) /usr/sbin/partx
 
     inst_libdir_file "libmultipath*" "multipath/*"
 
-- 
1.7.9.5

